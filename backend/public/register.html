<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è - –°–∏—Å—Ç–µ–º–∞ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <!-- –ü–µ—Ä–≤—ã–π —ç—Ç–∞–ø —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
            <div id="step1" class="card fade-in">
                <h1 class="auth-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
                <p style="text-align: center; margin-bottom: 2rem; color: var(--text-secondary);">
                    –®–∞–≥ 1 –∏–∑ 2: –°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞
                </p>
                
                <form id="registerFormStep1">
                    <div class="form-group">
                        <label for="email" class="form-label">Email</label>
                        <input 
                            type="email" 
                            id="email" 
                            name="email" 
                            class="form-input" 
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email"
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="password" class="form-label">–ü–∞—Ä–æ–ª—å</label>
                        <div style="position: relative;">
                            <input 
                                type="password" 
                                id="password" 
                                name="password" 
                                class="form-input" 
                                placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)"
                                required
                            >
                            <button 
                                type="button" 
                                id="togglePassword"
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer;"
                                onclick="togglePassword('password', 'togglePassword')"
                            >
                                üëÅÔ∏è‚Äçüó®Ô∏è
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmPassword" class="form-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</label>
                        <div style="position: relative;">
                            <input 
                                type="password" 
                                id="confirmPassword" 
                                name="confirmPassword" 
                                class="form-input" 
                                placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –µ—â–µ —Ä–∞–∑"
                                required
                            >
                            <button 
                                type="button" 
                                id="toggleConfirmPassword"
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer;"
                                onclick="togglePassword('confirmPassword', 'toggleConfirmPassword')"
                            >
                                üëÅÔ∏è‚Äçüó®Ô∏è
                            </button>
                        </div>
                    </div>
                    
                    <button type="submit" id="step1Button" class="btn btn-primary btn-block">
                        –î–∞–ª–µ–µ
                    </button>
                </form>
                
                <div class="auth-links">
                    <p>–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a href="/login">–í–æ–π—Ç–∏</a></p>
                </div>
            </div>
            
            <!-- –í—Ç–æ—Ä–æ–π —ç—Ç–∞–ø —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
            <div id="step2" class="card fade-in" style="display: none;">
                <h1 class="auth-title">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h1>
                <p style="text-align: center; margin-bottom: 2rem; color: var(--text-secondary);">
                    –®–∞–≥ 2 –∏–∑ 2: –õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                </p>
                
                <form id="registerFormStep2">
                    <div class="form-group">
                        <label for="fullName" class="form-label">–ü–æ–ª–Ω–æ–µ –∏–º—è (–§–ò–û)</label>
                        <input 
                            type="text" 
                            id="fullName" 
                            name="fullName" 
                            class="form-input" 
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –ø–æ–ª–Ω–æ–µ –∏–º—è"
                            required
                        >
                    </div>
                    
                    <div class="form-group">
                        <label for="birthDate" class="form-label">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è</label>
                        <input 
                            type="date" 
                            id="birthDate" 
                            name="birthDate" 
                            class="form-input" 
                            required
                        >
                    </div>
                    
                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="button" id="backButton" class="btn btn-secondary" style="flex: 1;">
                            –ù–∞–∑–∞–¥
                        </button>
                        <button type="submit" id="step2Button" class="btn btn-primary" style="flex: 1;">
                            –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/js/common.js"></script>
    <script>
        // –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–≤–æ–≥–æ —ç—Ç–∞–ø–∞
        let step1Data = null;
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—Ä–≤–æ–≥–æ —ç—Ç–∞–ø–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        document.getElementById('registerFormStep1').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!isValidEmail(email)) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∞–¥—Ä–µ—Å', 'error');
                return;
            }
            
            if (!isValidPassword(password)) {
                showMessage('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showMessage('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            setButtonLoading('step1Button', true);
            
            try {
                const response = await apiRequest('/auth/register-step1', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–≤–æ–≥–æ —ç—Ç–∞–ø–∞
                step1Data = { email, password };
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                showMessage('–ü–µ—Ä–≤—ã–π —ç—Ç–∞–ø –ø—Ä–æ–π–¥–µ–Ω!', 'success');
                
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫–æ –≤—Ç–æ—Ä–æ–º—É —ç—Ç–∞–ø—É
                setTimeout(() => {
                    document.getElementById('step1').style.display = 'none';
                    document.getElementById('step2').style.display = 'block';
                }, 500);
                
            } catch (error) {
                showMessage(error.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', 'error');
            } finally {
                setButtonLoading('step1Button', false);
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Ç–æ—Ä–æ–≥–æ —ç—Ç–∞–ø–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        document.getElementById('registerFormStep2').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fullName = document.getElementById('fullName').value;
            const birthDate = document.getElementById('birthDate').value;
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!fullName.trim()) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –∏–º—è', 'error');
                return;
            }
            
            if (!birthDate) {
                showMessage('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è', 'error');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑—Ä–∞—Å—Ç (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 13 –ª–µ—Ç)
            const birthDateObj = new Date(birthDate);
            const today = new Date();
            const age = today.getFullYear() - birthDateObj.getFullYear();
            const monthDiff = today.getMonth() - birthDateObj.getMonth();
            
            if (age < 13 || (age === 13 && monthDiff < 0)) {
                showMessage('–í–æ–∑—Ä–∞—Å—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 13 –ª–µ—Ç', 'error');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            setButtonLoading('step2Button', true);
            
            try {
                const response = await apiRequest('/auth/register-step2', {
                    method: 'POST',
                    body: JSON.stringify({ fullName, birthDate })
                });
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω
                setAuthToken(response.token);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                showMessage('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!', 'success');
                
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
                setTimeout(() => {
                    redirect('/dashboard');
                }, 1000);
                
            } catch (error) {
                showMessage(error.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', 'error');
            } finally {
                setButtonLoading('step2Button', false);
            }
        });
        
        // –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
        document.getElementById('backButton').addEventListener('click', function() {
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step1').style.display = 'block';
        });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        if (isAuthenticated()) {
            redirect('/dashboard');
        }
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è (13 –ª–µ—Ç –Ω–∞–∑–∞–¥)
        const today = new Date();
        const maxDate = new Date(today.getFullYear() - 13, today.getMonth(), today.getDate());
        document.getElementById('birthDate').max = maxDate.toISOString().split('T')[0];
    </script>
</body>
</html>
